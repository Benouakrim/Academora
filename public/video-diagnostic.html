<!DOCTYPE html>
<html>
<head>
    <title>Video Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #666; margin-top: 30px; }
        .section { margin: 20px 0; padding: 15px; border-radius: 4px; }
        .public-section { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .admin-section { background: #fff3e0; border-left: 4px solid #FF9800; }
        .video-card { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin: 10px 0; }
        .video-card.active { border-left: 4px solid #4CAF50; }
        .video-card.inactive { border-left: 4px solid #f44336; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .badge.active { background: #4CAF50; color: white; }
        .badge.inactive { background: #f44336; color: white; }
        .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .success { background: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .error { background: #f8d7da; border: 1px solid #dc3545; padding: 15px; border-radius: 4px; margin: 20px 0; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; border-radius: 4px; }
        .stat { font-size: 24px; font-weight: bold; color: #4CAF50; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #45a049; }
        .info { color: #666; font-size: 14px; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Video Diagnostic Tool</h1>
        <p class="info">This tool helps diagnose why videos in Admin Media Library don't appear on the homepage.</p>
        
        <div id="results">
            <p>Loading diagnostic information...</p>
        </div>
        
        <button onclick="location.reload()">üîÑ Refresh</button>
    </div>

    <script>
        async function runDiagnostic() {
            const resultsDiv = document.getElementById('results');
            
            try {
                // Get API URL
                const API_URL = 'http://localhost:3001/api';
                
                // Fetch public videos (what regular users see)
                console.log('Fetching from:', `${API_URL}/videos`);
                const publicResponse = await fetch(`${API_URL}/videos`);
                console.log('Public response status:', publicResponse.status);
                const publicVideos = await publicResponse.json();
                console.log('Public videos:', publicVideos);
                
                // Try to fetch admin videos (requires auth token)
                let adminVideos = null;
                const token = localStorage.getItem('token');
                if (token) {
                    try {
                        console.log('Fetching admin videos from:', `${API_URL}/admin/videos`);
                        const adminResponse = await fetch(`${API_URL}/admin/videos`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        console.log('Admin response status:', adminResponse.status);
                        if (adminResponse.ok) {
                            adminVideos = await adminResponse.json();
                            console.log('Admin videos:', adminVideos);
                        }
                    } catch (e) {
                        console.log('Could not fetch admin videos:', e);
                    }
                }
                
                // Build diagnostic HTML
                let html = '';
                
                // Summary
                html += '<h2>üìä Summary</h2>';
                html += `<div class="section public-section">`;
                html += `<p><strong>Public Videos (Regular Users See):</strong> <span class="stat">${Array.isArray(publicVideos) ? publicVideos.length : 0}</span></p>`;
                if (publicVideos.error) {
                    html += `<p class="error">Error: ${publicVideos.error}</p>`;
                }
                html += `</div>`;
                
                if (adminVideos && Array.isArray(adminVideos)) {
                    html += `<div class="section admin-section">`;
                    html += `<p><strong>Admin Videos (All Videos):</strong> <span class="stat">${adminVideos.length}</span></p>`;
                    const inactiveCount = adminVideos.filter(v => !v.is_active).length;
                    html += `<p><strong>Inactive Videos:</strong> ${inactiveCount}</p>`;
                    html += `</div>`;
                }
                
                // Diagnosis
                if (Array.isArray(publicVideos) && publicVideos.length === 0) {
                    html += `<div class="warning">`;
                    html += `<h3>‚ö†Ô∏è Problem Found!</h3>`;
                    html += `<p><strong>No videos are being returned by the public API.</strong></p>`;
                    html += `<p>This means either:</p>`;
                    html += `<ul>`;
                    html += `<li>There are no videos in the database at all, OR</li>`;
                    html += `<li>All videos in the database have <code>is_active = false</code></li>`;
                    html += `</ul>`;
                    
                    if (adminVideos && Array.isArray(adminVideos) && adminVideos.length > 0) {
                        html += `<h4>‚úÖ Solution:</h4>`;
                        html += `<p>You have ${adminVideos.length} video(s) in the Admin Media Library, but they are all marked as INACTIVE.</p>`;
                        html += `<p><strong>To fix:</strong> Go to Admin Media Library and toggle the "Active" checkbox on the videos you want to show on the homepage.</p>`;
                    } else {
                        html += `<p><strong>To fix:</strong> Add videos in the Admin Media Library and make sure the "Active" checkbox is checked.</p>`;
                    }
                    html += `</div>`;
                } else if (Array.isArray(publicVideos) && publicVideos.length > 0) {
                    html += `<div class="success">`;
                    html += `<h3>‚úÖ Good News!</h3>`;
                    html += `<p>The public API is returning ${publicVideos.length} video(s). Regular users should see these videos on the homepage.</p>`;
                    html += `</div>`;
                }
                
                // Public Videos Detail
                if (Array.isArray(publicVideos) && publicVideos.length > 0) {
                    html += `<h2>üë• Public Videos (What Regular Users See)</h2>`;
                    html += `<div class="section public-section">`;
                    publicVideos.forEach((video, i) => {
                        html += `<div class="video-card active">`;
                        html += `<h3>${i + 1}. ${video.title} <span class="badge active">ACTIVE</span></h3>`;
                        html += `<p><strong>ID:</strong> ${video.id}</p>`;
                        html += `<p><strong>Position:</strong> ${video.position || 0}</p>`;
                        html += `<p><strong>Video URL:</strong> ${video.video_url || '(none)'}</p>`;
                        html += `<p><strong>Thumbnail:</strong> ${video.thumbnail_url || '(none)'}</p>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                }
                
                // Admin Videos Detail
                if (adminVideos && Array.isArray(adminVideos) && adminVideos.length > 0) {
                    html += `<h2>üîß Admin Videos (All Videos in Database)</h2>`;
                    html += `<div class="section admin-section">`;
                    adminVideos.forEach((video, i) => {
                        const className = video.is_active ? 'video-card active' : 'video-card inactive';
                        const badgeClass = video.is_active ? 'badge active' : 'badge inactive';
                        const badgeText = video.is_active ? 'ACTIVE' : 'INACTIVE';
                        
                        html += `<div class="${className}">`;
                        html += `<h3>${i + 1}. ${video.title} <span class="${badgeClass}">${badgeText}</span></h3>`;
                        html += `<p><strong>ID:</strong> ${video.id}</p>`;
                        html += `<p><strong>Position:</strong> ${video.position || 0}</p>`;
                        html += `<p><strong>is_active:</strong> ${video.is_active ? '‚úÖ true' : '‚ùå false'}</p>`;
                        html += `<p><strong>Video URL:</strong> ${video.video_url || '(none)'}</p>`;
                        html += `<p><strong>Thumbnail:</strong> ${video.thumbnail_url || '(none)'}</p>`;
                        
                        if (!video.is_active) {
                            html += `<p style="color: #f44336;"><strong>‚ö†Ô∏è This video will NOT appear on the homepage for regular users!</strong></p>`;
                        }
                        
                        html += `</div>`;
                    });
                    html += `</div>`;
                } else if (!token) {
                    html += `<div class="section admin-section">`;
                    html += `<p class="info">Not logged in as admin. Cannot show all videos in database.</p>`;
                    html += `</div>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                        <p>Make sure the backend server is running on port 3001.</p>
                    </div>
                `;
                console.error('Diagnostic error:', error);
            }
        }

        runDiagnostic();
    </script>
</body>
</html>
